{"version":3,"file":"inmemory-cache-provider.js","sourceRoot":"","sources":["../../src/passport-saml/inmemory-cache-provider.ts"],"names":[],"mappings":";AAAA;;;;;;;;;;;;;GAaG;;;AAWH,MAAa,aAAa;IAItB,YAAY,OAAsC;QAC9C,IAAI,CAAC,SAAS,GAAG,EAAE,CAAC;QAEpB,IAAI,CAAC,OAAO,EAAE;YACV,OAAO,GAAG,EAAE,CAAC;SAChB;QAED,IAAG,CAAC,OAAO,CAAC,qBAAqB,EAAC;YAC9B,OAAO,CAAC,qBAAqB,GAAG,QAAQ,CAAC,CAAE,UAAU;SACxD;QAED,IAAI,CAAC,OAAO,GAAG,OAA+B,CAAC;QAE/C,wBAAwB;QACxB,MAAM,eAAe,GAAG,WAAW,CAAC,GAAG,EAAE;YACrC,MAAM,KAAK,GAAG,IAAI,IAAI,EAAE,CAAC,OAAO,EAAE,CAAC;YACnC,MAAM,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;YACzC,IAAI,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,EAAE;gBACjB,IAAG,KAAK,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,SAAS,CAAC,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,OAAO,CAAC,qBAAqB,EAAC;oBAC/F,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,GAAG,EAAE,CAAC,SAAS,CAAC,CAAC;iBACrC;YACL,CAAC,CAAC,CAAC;QACP,CAAC,EAAE,IAAI,CAAC,OAAO,CAAC,qBAAqB,CAAC,CAAC;QAEvC,wGAAwG;QACxG,qEAAqE;QACrE,yEAAyE;QACzE,IAAI,eAAe,CAAC,KAAK,IAAI,OAAO,CAAC,OAAO,KAAK,UAAU;YACvD,eAAe,CAAC,KAAK,EAAE,CAAC;IAChC,CAAC;IAED;;;;;OAKG;IACH,IAAI,CAAC,GAAW,EAAE,KAAa,EAAE,QAAwD;QACrF,IAAG,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,EACvB;YACI,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,GAAG;gBAClB,SAAS,EAAE,IAAI,IAAI,EAAE,CAAC,OAAO,EAAE;gBAC/B,KAAK,EAAE,KAAK;aACf,CAAC;YAEF,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC;SACvC;aAED;YACI,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;SACxB;IAEL,CAAC;IAGD;;;;OAIG;IACH,GAAG,CAAC,GAAW,EAAE,QAA4D;QACzE,IAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,EAAC;YACnB,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC;SAC7C;aAED;YACI,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;SACxB;IAEL,CAAC;IAGD;;;OAGG;IACH,MAAM,CAAC,GAAW,EAAE,QAAyD;QACzE,IAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,EACtB;YACI,OAAO,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;YAC3B,QAAQ,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC;SACvB;aAED;YACI,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;SACxB;IAEL,CAAC;CACJ;AA5FD,sCA4FC","sourcesContent":["/**\r\n * Simple in memory cache provider.  To be used to store state of requests that needs\r\n * to be validated/checked when a response is received.\r\n *\r\n * This is the default implementation of a cache provider used by Passport-SAML.  For\r\n * multiple server instances/load balanced scenarios (I.e. the SAML request could have\r\n * been generated from a different server/process handling the SAML response) this\r\n * implementation will NOT be sufficient.\r\n *\r\n * The caller should provide their own implementation for a cache provider as defined\r\n * in the config options for Passport-SAML.\r\n * @param options\r\n * @constructor\r\n */\r\n\r\nexport interface CacheItem {\r\n    value: string;\r\n    createdAt: number;\r\n}\r\n\r\ninterface CacheProviderOptions {\r\n    keyExpirationPeriodMs: number;\r\n}\r\n\r\nexport class CacheProvider {\r\n    cacheKeys: Record<string, CacheItem>;\r\n    options: CacheProviderOptions;\r\n\r\n    constructor(options: Partial<CacheProviderOptions>) {\r\n        this.cacheKeys = {};\r\n\r\n        if (!options) {\r\n            options = {};\r\n        }\r\n\r\n        if(!options.keyExpirationPeriodMs){\r\n            options.keyExpirationPeriodMs = 28800000;  // 8 hours\r\n        }\r\n\r\n        this.options = options as CacheProviderOptions;\r\n\r\n        // Expire old cache keys\r\n        const expirationTimer = setInterval(() => {\r\n            const nowMs = new Date().getTime();\r\n            const keys = Object.keys(this.cacheKeys);\r\n            keys.forEach((key) => {\r\n                if(nowMs >= new Date(this.cacheKeys[key].createdAt).getTime() + this.options.keyExpirationPeriodMs){\r\n                    this.remove(key, () => undefined);\r\n                }\r\n            });\r\n        }, this.options.keyExpirationPeriodMs);\r\n\r\n        // we only want this to run if the process is still open; it shouldn't hold the process open (issue #68)\r\n        //   (unref only introduced in node 0.9, so check whether we have it)\r\n        // Skip this in 0.10.34 due to https://github.com/joyent/node/issues/8900\r\n        if (expirationTimer.unref && process.version !== 'v0.10.34')\r\n            expirationTimer.unref();\r\n    }\r\n\r\n    /**\r\n     * Store an item in the cache, using the specified key and value.\r\n     * Internally will keep track of the time the item was added to the cache\r\n     * @param id\r\n     * @param value\r\n     */\r\n    save(key: string, value: string, callback: (error: null, value: CacheItem | null) => void){\r\n        if(!this.cacheKeys[key])\r\n        {\r\n            this.cacheKeys[key] = {\r\n                createdAt: new Date().getTime(),\r\n                value: value\r\n            };\r\n\r\n            callback(null, this.cacheKeys[key]);\r\n        }\r\n        else\r\n        {\r\n            callback(null, null);\r\n        }\r\n\r\n    }\r\n\r\n\r\n    /**\r\n     * Returns the value of the specified key in the cache\r\n     * @param id\r\n     * @returns {boolean}\r\n     */\r\n    get(key: string, callback: (key: string | null, value: string | null) => void){\r\n        if(this.cacheKeys[key]){\r\n            callback(null, this.cacheKeys[key].value);\r\n        }\r\n        else\r\n        {\r\n            callback(null, null);\r\n        }\r\n\r\n    }\r\n\r\n\r\n    /**\r\n     * Removes an item from the cache if it exists\r\n     * @param key\r\n     */\r\n    remove(key: string, callback: (err: Error | null, key: string | null) => void){\r\n        if(this.cacheKeys[key])\r\n        {\r\n            delete this.cacheKeys[key];\r\n            callback(null, key);\r\n        }\r\n        else\r\n        {\r\n            callback(null, null);\r\n        }\r\n\r\n    }\r\n}\r\n"]}